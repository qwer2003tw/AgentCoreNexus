#!/bin/bash
# .git/hooks/pre-commit
# 
# ç›®çš„ï¼šç¢ºä¿æ‰€æœ‰ commit éƒ½ç¶“éå®Œæ•´é©—è­‰
# åŸ·è¡Œè€…ï¼šä¸»è¦æ˜¯ AI agentsï¼ˆClineï¼‰
# æ™‚é–“ï¼š2-5 åˆ†é˜ï¼ˆAI å¯æ¥å—ï¼‰
#
# æ­¤ hook å¼·åˆ¶åŸ·è¡Œ clinerules ä¸­å®šç¾©çš„æ‰€æœ‰è³ªé‡æª¢æŸ¥ï¼š
# - CODE_QUALITY_WORKFLOW.md: Ruff æª¢æŸ¥
# - TEST_EXECUTION_WORKFLOW.md: å®Œæ•´æ¸¬è©¦å¥—ä»¶
# - MANDATORY_CHECKLIST.md: è¦†è“‹ç‡æª¢æŸ¥

set -e

echo "ğŸ” Pre-commit: å®Œæ•´è³ªé‡æª¢æŸ¥..."
echo "ï¼ˆé è¨ˆæ™‚é–“ï¼š2-5 åˆ†é˜ï¼‰"
echo ""

# ============================================
# æª¢æ¸¬ Python æ–‡ä»¶è®Šæ›´
# ============================================
changed_py=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$changed_py" ]; then
    echo "â„¹ï¸  ç„¡ Python æ–‡ä»¶è®Šæ›´ï¼Œè·³éæª¢æŸ¥"
    exit 0
fi

echo "ğŸ“ æª¢æ¸¬åˆ° Python æ–‡ä»¶è®Šæ›´ï¼ŒåŸ·è¡Œå®Œæ•´æª¢æŸ¥..."
echo ""

# ============================================
# Step 1: ä»£ç¢¼è³ªé‡æª¢æŸ¥ï¼ˆRuffï¼‰â­
# ============================================
echo "ğŸ” Step 1/4: ä»£ç¢¼è³ªé‡æª¢æŸ¥ï¼ˆRuffï¼‰..."

# telegram-lambda
if echo "$changed_py" | grep -q "^telegram-lambda/"; then
    echo "  â†’ Checking telegram-lambda..."
    cd telegram-lambda
    ruff check . --fix || {
        echo "âŒ Ruff check å¤±æ•—ï¼ˆtelegram-lambdaï¼‰"
        exit 1
    }
    ruff format . || {
        echo "âŒ Ruff format å¤±æ•—ï¼ˆtelegram-lambdaï¼‰"
        exit 1
    }
    ruff check . || {
        echo "âŒ Ruff ä»æœ‰éŒ¯èª¤ï¼ˆtelegram-lambdaï¼‰"
        exit 1
    }
    cd ..
fi

# telegram-agentcore-bot
if echo "$changed_py" | grep -q "^telegram-agentcore-bot/"; then
    echo "  â†’ Checking telegram-agentcore-bot..."
    cd telegram-agentcore-bot
    ruff check . --fix || {
        echo "âŒ Ruff check å¤±æ•—ï¼ˆtelegram-agentcore-botï¼‰"
        exit 1
    }
    ruff format . || {
        echo "âŒ Ruff format å¤±æ•—ï¼ˆtelegram-agentcore-botï¼‰"
        exit 1
    }
    ruff check . || {
        echo "âŒ Ruff ä»æœ‰éŒ¯èª¤ï¼ˆtelegram-agentcore-botï¼‰"
        exit 1
    }
    cd ..
fi

echo "âœ… Step 1/4: ä»£ç¢¼è³ªé‡æª¢æŸ¥é€šé"
echo ""

# ============================================
# Step 2: å–®å…ƒæ¸¬è©¦ â­
# ============================================
echo "ğŸ§ª Step 2/4: å–®å…ƒæ¸¬è©¦..."

# telegram-lambda
if echo "$changed_py" | grep -q "^telegram-lambda/"; then
    echo "  â†’ Testing telegram-lambda (unit tests)..."
    cd telegram-lambda
    python3.11 -m pytest tests/ --ignore=tests/e2e/ -v || {
        echo "âŒ å–®å…ƒæ¸¬è©¦å¤±æ•—ï¼ˆtelegram-lambdaï¼‰"
        exit 1
    }
    cd ..
fi

# telegram-agentcore-bot
if echo "$changed_py" | grep -q "^telegram-agentcore-bot/"; then
    echo "  â†’ Testing telegram-agentcore-bot..."
    cd telegram-agentcore-bot
    python3.11 -m pytest tests/ -v || {
        echo "âŒ æ¸¬è©¦å¤±æ•—ï¼ˆtelegram-agentcore-botï¼‰"
        exit 1
    }
    cd ..
fi

echo "âœ… Step 2/4: å–®å…ƒæ¸¬è©¦é€šé"
echo ""

# ============================================
# Step 3: E2E æ¸¬è©¦ â­
# ============================================
echo "ğŸ­ Step 3/4: E2E æ¸¬è©¦..."

if echo "$changed_py" | grep -q "^telegram-lambda/"; then
    echo "  â†’ E2E testing telegram-lambda..."
    cd telegram-lambda
    
    # æª¢æŸ¥æ˜¯å¦å®‰è£äº† E2E ä¾è³´
    if ! pip list | grep -q aiogram; then
        echo "âš ï¸  E2E ä¾è³´æœªå®‰è£ï¼Œè·³é E2E æ¸¬è©¦"
        echo "   åŸ·è¡Œï¼špip install -r requirements-test.txt"
    else
        python3.11 -m pytest tests/e2e/ -v || {
            echo "âŒ E2E æ¸¬è©¦å¤±æ•—"
            exit 1
        }
    fi
    cd ..
fi

echo "âœ… Step 3/4: E2E æ¸¬è©¦é€šéï¼ˆæˆ–å·²è·³éï¼‰"
echo ""

# ============================================
# Step 4: è¦†è“‹ç‡æª¢æŸ¥ â­
# ============================================
echo "ğŸ“Š Step 4/4: è¦†è“‹ç‡æª¢æŸ¥..."

if echo "$changed_py" | grep -q "^telegram-lambda/"; then
    echo "  â†’ Coverage check for telegram-lambda..."
    cd telegram-lambda
    
    # ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
    python3.11 -m pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing
    
    # å˜—è©¦ diff-coverï¼ˆæ–°ä»£ç¢¼è¦†è“‹ç‡ï¼‰
    if command -v diff-cover &> /dev/null; then
        if git rev-parse origin/main &> /dev/null 2>&1; then
            echo "  â†’ æª¢æŸ¥æ–°ä»£ç¢¼è¦†è“‹ç‡ï¼ˆâ‰¥ 80%ï¼‰..."
            diff-cover coverage.xml --compare-branch=origin/main --fail-under=80 || {
                echo "âš ï¸  æ–°ä»£ç¢¼è¦†è“‹ç‡ä¸è¶³ 80%"
                echo ""
                echo "è«‹ç‚ºæ–°ä»£ç¢¼æ·»åŠ æ¸¬è©¦ï¼Œç¢ºä¿è¦†è“‹ç‡ â‰¥ 80%"
                exit 1
            }
        else
            echo "  â†’ ç„¡æ³•é€£æ¥ origin/mainï¼Œæª¢æŸ¥æ•´é«”è¦†è“‹ç‡ï¼ˆâ‰¥ 70%ï¼‰..."
            python3.11 -m pytest tests/ --cov=src --cov-fail-under=70 || {
                echo "âš ï¸  æ•´é«”è¦†è“‹ç‡ä¸è¶³ 70%"
                exit 1
            }
        fi
    else
        echo "  â†’ diff-cover æœªå®‰è£ï¼Œæª¢æŸ¥æ•´é«”è¦†è“‹ç‡ï¼ˆâ‰¥ 70%ï¼‰..."
        python3.11 -m pytest tests/ --cov=src --cov-fail-under=70 || {
            echo "âš ï¸  æ•´é«”è¦†è“‹ç‡ä¸è¶³ 70%"
            exit 1
        }
    fi
    cd ..
fi

echo "âœ… Step 4/4: è¦†è“‹ç‡æª¢æŸ¥é€šé"
echo ""

# ============================================
# æ‰€æœ‰æª¢æŸ¥å®Œæˆ
# ============================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… æ‰€æœ‰æª¢æŸ¥é€šéï¼ä»£ç¢¼å·²æº–å‚™å¥½ commit"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

exit 0