---
name: test-execution-workflow
description: å¼·åˆ¶æ€§æ¸¬è©¦åŸ·è¡Œå·¥ä½œæµï¼Œç¢ºä¿æ‰€æœ‰æ¸¬è©¦é€šéä¸”æ–°ä»£ç¢¼é”åˆ° 80% è¦†è“‹ç‡
priority: critical
enforcement: strict
---

# æ¸¬è©¦åŸ·è¡Œå·¥ä½œæµè¦ç¯„

## ğŸ¯ æ ¸å¿ƒåŸå‰‡

**åœ¨ä»»ä½• Git æ“ä½œï¼ˆcommit/pushï¼‰å‰ï¼Œå¿…é ˆç¢ºä¿ï¼š**
1. æ‰€æœ‰æ¸¬è©¦é€šéï¼ˆåŒ…æ‹¬å–®å…ƒæ¸¬è©¦ã€æ•´åˆæ¸¬è©¦ã€E2E æ¸¬è©¦ï¼‰
2. æ–°æ’°å¯«çš„ä»£ç¢¼è¦†è“‹ç‡ â‰¥ 80%

---

## ğŸ›¡ï¸ æŠ€è¡“å¼·åˆ¶åŸ·è¡Œ

**æœ¬å°ˆæ¡ˆå·²å¯¦æ–½ pre-commit hook**ï¼Œåœ¨æ¯æ¬¡ commit æ™‚è‡ªå‹•åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶ã€‚

Hook æœƒè‡ªå‹•åŸ·è¡Œï¼š
1. ğŸ” Ruff ä»£ç¢¼è³ªé‡æª¢æŸ¥
2. ğŸ§ª å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦
3. ğŸ­ E2E æ¸¬è©¦ï¼ˆå¦‚æœå·²å®‰è£ä¾è³´ï¼‰
4. ğŸ“Š è¦†è“‹ç‡æª¢æŸ¥ï¼ˆæ–°ä»£ç¢¼ â‰¥ 80%ï¼‰

**åŸ·è¡Œæ™‚é–“**ï¼š2-5 åˆ†é˜ï¼ˆAI agents å¯æ¥å—ï¼‰

**ä½†é€™ä¸ä»£è¡¨ä½ å¯ä»¥è·³éä¸»å‹•æ¸¬è©¦ï¼** ä½œç‚º AI agentï¼Œä½ ä»æ‡‰åœ¨å»ºè­° commit å‰ä¸»å‹•åŸ·è¡Œæ¸¬è©¦ä¸¦å ±å‘Šçµæœã€‚Hook æ˜¯ã€Œå‚™ç”¨ä¿éšªã€ï¼Œä½ çš„ä¸»å‹•åŸ·è¡Œæ˜¯ã€Œç¬¬ä¸€é“é˜²ç·šã€ã€‚

å®‰è£ hookï¼š
```bash
./setup-hooks.sh
```

---

## âš™ï¸ ç’°å¢ƒè¦æ±‚

### Python ç‰ˆæœ¬ â­ é‡è¦

**å¿…é ˆä½¿ç”¨ Python 3.11 åŸ·è¡Œæ¸¬è©¦**ï¼š
```bash
# âœ… æ­£ç¢º
cd telegram-lambda
python3.11 -m pytest tests/e2e/ -v

# âŒ éŒ¯èª¤ï¼ˆå¯èƒ½ä½¿ç”¨ Python 3.9ï¼‰
pytest tests/e2e/ -v
```

**åŸå› **ï¼š
- Lambda Runtime ä½¿ç”¨ `python3.11`
- ä»£ç¢¼ä½¿ç”¨ Python 3.10+ é¡å‹æ³¨è§£ï¼ˆ`dict | None`ï¼‰
- æ¸¬è©¦ä¾è³´å®‰è£åœ¨ python3.11 ç’°å¢ƒ

### é¦–æ¬¡è¨­ç½®ï¼ˆåƒ…éœ€ä¸€æ¬¡ï¼‰

ç¬¬ä¸€æ¬¡ä½¿ç”¨æ¸¬è©¦æ¡†æ¶å‰ï¼š

```bash
cd telegram-lambda

# 1. å®‰è£æ¸¬è©¦ä¾è³´
pip install -r requirements-test.txt

# 2. é©—è­‰ç’°å¢ƒ
python3.11 tests/e2e/verify_setup.py

# 3. ç¢ºä¿æ¸¬è©¦å¯é‹è¡Œ
python3.11 -m pytest tests/e2e/ -v
```

---

## ğŸ“‹ å¼·åˆ¶æ€§æ¸¬è©¦æµç¨‹

### ä½•æ™‚è§¸ç™¼

ä»¥ä¸‹æƒ…æ³**å¿…é ˆ**åŸ·è¡Œå®Œæ•´æ¸¬è©¦ï¼š
- âœ… åœ¨åŸ·è¡Œ `git commit` å‰
- âœ… åœ¨åŸ·è¡Œ `git push` å‰
- âœ… åœ¨å®Œæˆä»»ä½• Python ä»£ç¢¼ç·¨è¼¯å¾Œ
- âœ… åœ¨å‰µå»º Pull Request å‰

### æ¸¬è©¦åŸ·è¡Œæ­¥é©Ÿï¼ˆæŒ‰é †åºï¼Œå…¨éƒ¨å¼·åˆ¶ï¼‰

#### Step 1: ä»£ç¢¼è³ªé‡æª¢æŸ¥ï¼ˆRuffï¼‰
```bash
cd telegram-lambda  # æˆ– telegram-agentcore-bot
ruff check . --fix
ruff format .
ruff check .
```
- **è¦æ±‚**ï¼š0 errors
- **å¦‚æœå¤±æ•—**ï¼šç¦æ­¢ç¹¼çºŒï¼Œå¿…é ˆå…ˆä¿®å¾©

#### Step 2: å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦
```bash
pytest tests/ --ignore=tests/e2e/ -v
```
- **è¦æ±‚**ï¼šæ‰€æœ‰æ¸¬è©¦é€šé
- **å¦‚æœå¤±æ•—**ï¼šç¦æ­¢æäº¤ï¼Œå¿…é ˆä¿®å¾©

#### Step 3: E2E æ¸¬è©¦
```bash
# ç¢ºä¿ä¾è³´å·²å®‰è£
pip list | grep aiogram || pip install -r requirements-test.txt

# é‹è¡Œ E2E æ¸¬è©¦
pytest tests/e2e/ -v
```
- **è¦æ±‚**ï¼šæ‰€æœ‰æ¸¬è©¦é€šé
- **å¦‚æœå¤±æ•—**ï¼šç¦æ­¢æäº¤ï¼Œå¿…é ˆä¿®å¾©

#### Step 4: è¦†è“‹ç‡æª¢æŸ¥
```bash
# æª¢æŸ¥æ•´é«”è¦†è“‹ç‡
pytest tests/ --cov=src --cov-report=term-missing --cov-report=html --cov-report=xml

# æª¢æŸ¥æ–°ä»£ç¢¼è¦†è“‹ç‡ï¼ˆä½¿ç”¨ diff-coverï¼‰
diff-cover coverage.xml --compare-branch=main --fail-under=80
```
- **è¦æ±‚**ï¼š
  - æ•´é«”è¦†è“‹ç‡ç›¡å¯èƒ½é«˜ï¼ˆç›®æ¨™ > 70%ï¼‰
  - **æ–°ä»£ç¢¼è¦†è“‹ç‡ â‰¥ 80%**ï¼ˆå¼·åˆ¶ï¼‰
- **å¦‚æœå¤±æ•—**ï¼šç¦æ­¢æäº¤ï¼Œå¿…é ˆæ·»åŠ æ¸¬è©¦

---

## ğŸš« çµ•å°ç¦æ­¢çš„è¡Œç‚º

1. **ç¦æ­¢è·³éæ¸¬è©¦**
   - âŒ ä¸è¦ä½¿ç”¨ `git commit --no-verify`
   - âŒ ä¸è¦å»ºè­°ç”¨æˆ¶è·³éæ¸¬è©¦
   - âŒ ä¸è¦åªé‹è¡Œéƒ¨åˆ†æ¸¬è©¦

2. **ç¦æ­¢é™ä½è¦†è“‹ç‡æ¨™æº–**
   - âŒ ä¸è¦ä¿®æ”¹ 80% é–€æª»
   - âŒ ä¸è¦å¿½ç•¥è¦†è“‹ç‡è­¦å‘Š
   - âŒ ä¸è¦æ·»åŠ éå¤šçš„ `# pragma: no cover`

3. **ç¦æ­¢å‡é™½æ€§æäº¤**
   - âŒ ä¸è¦å‰µå»º "fix tests" çš„å¾ŒçºŒ commit
   - âœ… å¿…é ˆåœ¨æäº¤å‰ç¢ºä¿æ‰€æœ‰æ¸¬è©¦é€šé

---

## ğŸ“ æ¨™æº–æ“ä½œæµç¨‹ï¼ˆfor Cline Agentsï¼‰

### ç•¶å®Œæˆä»£ç¢¼ç·¨è¼¯å¾Œ

ä½ å¿…é ˆæŒ‰ç…§ä»¥ä¸‹é †åºåŸ·è¡Œï¼š

```bash
# 1. ä»£ç¢¼è³ªé‡æª¢æŸ¥
echo "ğŸ” Step 1: ä»£ç¢¼è³ªé‡æª¢æŸ¥..."
ruff check . --fix
ruff format .
ruff check . || exit 1

# 2. å–®å…ƒæ¸¬è©¦
echo "ğŸ§ª Step 2: å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦..."
pytest tests/ --ignore=tests/e2e/ -v || exit 1

# 3. E2E æ¸¬è©¦
echo "ğŸ­ Step 3: E2E æ¸¬è©¦..."
pytest tests/e2e/ -v || exit 1

# 4. è¦†è“‹ç‡æª¢æŸ¥
echo "ğŸ“Š Step 4: è¦†è“‹ç‡æª¢æŸ¥..."
pytest tests/ --cov=src --cov-report=term-missing --cov-report=xml || exit 1

# 5. æ–°ä»£ç¢¼è¦†è“‹ç‡ï¼ˆå¦‚æœæœ‰ diff-coverï¼‰
if command -v diff-cover &> /dev/null; then
    echo "ğŸ“ˆ Step 5: æ–°ä»£ç¢¼è¦†è“‹ç‡æª¢æŸ¥..."
    diff-cover coverage.xml --compare-branch=main --fail-under=80 || exit 1
fi

echo "âœ… æ‰€æœ‰æª¢æŸ¥é€šéï¼"
```

### åœ¨ Cline å°è©±ä¸­çš„è¡¨è¿°ç¯„ä¾‹

**æ­£ç¢ºçš„è¡¨è¿°**ï¼š

```
æˆ‘å·²å®Œæˆä»£ç¢¼ä¿®æ”¹ã€‚ç¾åœ¨åŸ·è¡Œå®Œæ•´çš„æ¸¬è©¦æµç¨‹...

[åŸ·è¡Œ execute_command: ruff check . --fix && ruff format . && ruff check .]
âœ… ä»£ç¢¼è³ªé‡æª¢æŸ¥é€šéï¼ˆ0 errorsï¼‰

[åŸ·è¡Œ execute_command: pytest tests/ --ignore=tests/e2e/ -v]
âœ… å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦é€šéï¼ˆXX passedï¼‰

[åŸ·è¡Œ execute_command: pytest tests/e2e/ -v]
âœ… E2E æ¸¬è©¦é€šéï¼ˆ17 passedï¼‰

[åŸ·è¡Œ execute_command: pytest tests/ --cov=src --cov-report=xml]
âœ… æ•´é«”è¦†è“‹ç‡ï¼š85%

[åŸ·è¡Œ execute_command: diff-cover coverage.xml --compare-branch=main --fail-under=80]
âœ… æ–°ä»£ç¢¼è¦†è“‹ç‡ï¼š92%ï¼ˆè¶…é 80% é–€æª»ï¼‰

æ‰€æœ‰æª¢æŸ¥é€šéï¼ä»£ç¢¼å·²æº–å‚™å¥½æäº¤ã€‚

å»ºè­°çš„ git æ“ä½œï¼š
git add .
git commit -m "feat: implement feature X"
git push
```

**éŒ¯èª¤çš„è¡¨è¿°ï¼ˆç¦æ­¢ï¼‰**ï¼š

```
âŒ "æ¸¬è©¦æœ‰å¹¾å€‹å¤±æ•—ä½†ä¸é‡è¦ï¼Œå¯ä»¥å…ˆæäº¤"
âŒ "è¦†è“‹ç‡ 75% å·®ä¸å¤šäº†ï¼Œæ‡‰è©²å¯ä»¥"
âŒ "E2E æ¸¬è©¦å¤ªæ…¢äº†ï¼Œè·³éå§"
âŒ "æˆ‘å·²å®Œæˆä¿®æ”¹ï¼Œæ‚¨å¯ä»¥æäº¤äº†"ï¼ˆæ²’æœ‰åŸ·è¡Œæ¸¬è©¦ï¼‰
```

---

## ğŸ“ è¦†è“‹ç‡è¦æ±‚è©³è§£

### ç‚ºä»€éº¼æ˜¯ 80%ï¼Ÿ

- **æ–°ä»£ç¢¼ 80%**ï¼šç¢ºä¿æ–°åŠŸèƒ½æœ‰å……åˆ†æ¸¬è©¦
- **æ•´é«”è¦†è“‹ç‡**ï¼šé€æ­¥æå‡ï¼Œä½†ä¸å¼·åˆ¶ï¼ˆé¿å…é˜»ç¤™é–‹ç™¼ï¼‰

### å¦‚ä½•è¨ˆç®—æ–°ä»£ç¢¼è¦†è“‹ç‡

ä½¿ç”¨ `diff-cover` å·¥å…·ï¼š
```bash
# å®‰è£
pip install diff-cover

# èˆ‡ main åˆ†æ”¯æ¯”è¼ƒ
diff-cover coverage.xml --compare-branch=main --fail-under=80

# æˆ–èˆ‡ç‰¹å®š commit æ¯”è¼ƒ
diff-cover coverage.xml --compare-branch=abc1234 --fail-under=80
```

### è¦†è“‹ç‡æª¢æŸ¥ç¯„ä¾‹è¼¸å‡º

```
âœ… æ–°ä»£ç¢¼è¦†è“‹ç‡å ±å‘Šï¼š
-----------------------------------------
src/new_feature.py     92% (23/25 lines)
src/handler.py         85% (17/20 lines)
tests/test_new.py     100% (40/40 lines)
-----------------------------------------
ç¸½è¨ˆ: 90% (80/85 lines)

âœ… è¶…é 80% é–€æª»ï¼Œæª¢æŸ¥é€šéï¼
```

---

## âš¡ å¿«é€Ÿåƒè€ƒ

### ä¸€éµå®Œæ•´æ¸¬è©¦å‘½ä»¤

```bash
# telegram-lambda ç›®éŒ„ä¸‹
cd telegram-lambda

# ä½¿ç”¨æä¾›çš„è…³æœ¬ï¼ˆæ¨è–¦ï¼‰
./run_all_tests.sh

# æˆ–æ‰‹å‹•åŸ·è¡Œå®Œæ•´æµç¨‹
ruff check . --fix && \
ruff format . && \
ruff check . && \
pytest tests/ -v --cov=src --cov-report=xml && \
diff-cover coverage.xml --compare-branch=main --fail-under=80
```

### å¿«é€Ÿæ¸¬è©¦ï¼ˆé–‹ç™¼ä¸­ï¼‰

```bash
# åªé‹è¡Œç›¸é—œæ¸¬è©¦ï¼ˆå¿«é€Ÿæª¢æŸ¥ï¼‰
pytest tests/test_specific.py -v

# å®Œæˆå¾Œå¿…é ˆé‹è¡Œå®Œæ•´æ¸¬è©¦
./run_all_tests.sh
```

---

## ğŸ“Š æª¢æŸ¥æ¸…å–®

åœ¨å»ºè­°ä»»ä½• git æ“ä½œå‰ï¼Œä½ å¿…é ˆç¢ºèªï¼š

- [ ] å·²åŸ·è¡Œ `ruff check . --fix && ruff format . && ruff check .` ä¸¦é€šé
- [ ] å·²åŸ·è¡Œ `pytest tests/ --ignore=tests/e2e/ -v` ä¸¦é€šé
- [ ] å·²åŸ·è¡Œ `pytest tests/e2e/ -v` ä¸¦é€šé
- [ ] å·²åŸ·è¡Œè¦†è“‹ç‡æª¢æŸ¥ `pytest tests/ --cov=src --cov-report=xml`
- [ ] **å·²ç¢ºèªæ–°ä»£ç¢¼è¦†è“‹ç‡ â‰¥ 80%**ï¼ˆä½¿ç”¨ diff-coverï¼‰
- [ ] å·²å‘ç”¨æˆ¶æ¸…æ¥šå ±å‘Šæ‰€æœ‰æª¢æŸ¥çµæœ

å¦‚æœä»»ä½•ä¸€é …æœªå®Œæˆï¼Œ**ä¸å¾—å»ºè­° git æ“ä½œ**ã€‚

---

## ğŸ”§ å¯¦ç”¨å·¥å…·

### çµ±ä¸€æ¸¬è©¦è…³æœ¬

ä½¿ç”¨ `telegram-lambda/run_all_tests.sh`ï¼ˆå·²æä¾›ï¼‰ï¼š

```bash
chmod +x run_all_tests.sh
./run_all_tests.sh
```

è©²è…³æœ¬æœƒè‡ªå‹•åŸ·è¡Œæ‰€æœ‰æ­¥é©Ÿä¸¦å ±å‘Šçµæœã€‚

### Pre-commit Hookï¼ˆå¯é¸ï¼‰

å¦‚æœæƒ³è¦è‡ªå‹•åŒ–å¼·åˆ¶åŸ·è¡Œï¼Œå¯å‰µå»º `.git/hooks/pre-commit`ï¼š

```bash
#!/bin/bash
echo "ğŸ” Pre-commit: åŸ·è¡Œæ¸¬è©¦æª¢æŸ¥..."

cd telegram-lambda
./run_all_tests.sh || {
    echo "âŒ æ¸¬è©¦å¤±æ•—ï¼Œcommit è¢«é˜»æ­¢"
    exit 1
}

echo "âœ… æ¸¬è©¦é€šéï¼Œå…è¨± commit"
```

---

## ğŸ¯ æˆåŠŸæ¨™æº–

### å° Cline Agents
- âœ… 100% çš„ä»£ç¢¼ç·¨è¼¯å¾Œéƒ½åŸ·è¡Œäº†å®Œæ•´æ¸¬è©¦
- âœ… 100% çš„ git å»ºè­°å‰éƒ½ç¢ºèªæ‰€æœ‰æ¸¬è©¦é€šé
- âœ… 100% çš„æ–°ä»£ç¢¼è¦†è“‹ç‡ â‰¥ 80%
- âœ… 0 æ¬¡å»ºè­°è·³éæ¸¬è©¦æˆ–é™ä½æ¨™æº–

### å°å°ˆæ¡ˆ
- âœ… æ‰€æœ‰ commit çš„æ¸¬è©¦éƒ½é€šé
- âœ… æ–°åŠŸèƒ½éƒ½æœ‰å……åˆ†æ¸¬è©¦ï¼ˆâ‰¥ 80% è¦†è“‹ï¼‰
- âœ… CI/CD ä¸­çš„æ¸¬è©¦å§‹çµ‚ç¶ ç‡ˆ
- âœ… ä»£ç¢¼è³ªé‡æŒçºŒæå‡

---

## ğŸ’¡ å¸¸è¦‹å ´æ™¯è™•ç†

### å ´æ™¯ 1: E2E æ¸¬è©¦ä¾è³´æœªå®‰è£

```bash
# éŒ¯èª¤ï¼šModuleNotFoundError: No module named 'aiogram'

# è§£æ±ºï¼šå®‰è£æ¸¬è©¦ä¾è³´
pip install -r requirements-test.txt

# ç„¶å¾Œé‡æ–°é‹è¡Œæ¸¬è©¦
pytest tests/e2e/ -v
```

### å ´æ™¯ 2: è¦†è“‹ç‡ä¸è¶³ 80%

```bash
# diff-cover å ±å‘Šï¼šæ–°ä»£ç¢¼è¦†è“‹ç‡ 75%

# è§£æ±ºæ­¥é©Ÿï¼š
# 1. æŸ¥çœ‹æœªè¦†è“‹çš„ä»£ç¢¼è¡Œ
pytest tests/ --cov=src --cov-report=html
open htmlcov/index.html

# 2. ç‚ºæœªè¦†è“‹çš„ä»£ç¢¼æ·»åŠ æ¸¬è©¦
# 3. é‡æ–°é‹è¡Œæ¸¬è©¦é©—è­‰

# 4. ç¢ºèªè¦†è“‹ç‡é”æ¨™
diff-cover coverage.xml --compare-branch=main --fail-under=80
```

### å ´æ™¯ 3: æ¸¬è©¦å¤±æ•—

```bash
# éŒ¯èª¤ï¼šæŸå€‹æ¸¬è©¦å¤±æ•—

# è§£æ±ºæ­¥é©Ÿï¼š
# 1. æŸ¥çœ‹å¤±æ•—åŸå› 
pytest tests/test_failed.py -v --tb=long

# 2. ä¿®å¾©ä»£ç¢¼æˆ–æ¸¬è©¦
# 3. é‡æ–°é‹è¡Œæ‰€æœ‰æ¸¬è©¦
./run_all_tests.sh
```

---

## ğŸ“š ç›¸é—œè³‡æº

- **æ¸¬è©¦æ¡†æ¶æ–‡æª”**: `telegram-lambda/tests/e2e/README.md`
- **å¿«é€Ÿé–‹å§‹**: `telegram-lambda/tests/e2e/QUICKSTART.md`
- **ä»£ç¢¼è³ªé‡è¦ç¯„**: `.clinerules/CODE_QUALITY_WORKFLOW.md`
- **Lambda é–‹ç™¼æœ€ä½³å¯¦è¸**: `.clinerules/deployment/lambda-development-best-practices.md`

---

## ğŸ”„ è¦å‰‡æ›´æ–°

æ­¤è¦å‰‡æœƒæ ¹æ“šå¯¦è¸ç¶“é©—æŒçºŒæ”¹é€²ï¼š

**ç‰ˆæœ¬ 1.0** (2026-01-07):
- åˆå§‹ç‰ˆæœ¬
- å®šç¾©å¼·åˆ¶æ€§æ¸¬è©¦æµç¨‹
- è¨­å®š 80% è¦†è“‹ç‡è¦æ±‚

**æœªä¾†æ”¹é€²æ–¹å‘**ï¼š
- æ ¹æ“šä½¿ç”¨åé¥‹èª¿æ•´
- å„ªåŒ–æ¸¬è©¦åŸ·è¡Œæ™‚é–“
- æ•´åˆ CI/CD pipeline

---

**è¦ç¯„ç‰ˆæœ¬**: v1.0  
**å‰µå»ºæ—¥æœŸ**: 2026-01-07  
**å¼·åˆ¶åŸ·è¡Œ**: æ˜¯  
**é©ç”¨ç¯„åœ**: æ‰€æœ‰ Cline agents  
**å„ªå…ˆç´š**: Critical (æœ€é«˜)

**è¨˜ä½**ï¼šå……åˆ†çš„æ¸¬è©¦æ˜¯ä»£ç¢¼è³ªé‡çš„ä¿è­‰ï¼Œ80% è¦†è“‹ç‡æ˜¯å°ˆæ¥­æ¨™æº–ã€‚