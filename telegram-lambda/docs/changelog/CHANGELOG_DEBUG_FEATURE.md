# è®Šæ›´æ—¥èªŒ - `/debug test` åŠŸèƒ½

## ç‰ˆæœ¬è³‡è¨Š
- **åŠŸèƒ½**: æ–°å¢ `/debug test` é™¤éŒ¯æŒ‡ä»¤
- **æ—¥æœŸ**: 2025-11-04
- **é¡å‹**: åŠŸèƒ½å¢å¼·

## è®Šæ›´æ‘˜è¦

æ–°å¢äº†ä¸€å€‹ç‰¹æ®Šçš„é™¤éŒ¯æŒ‡ä»¤ï¼Œå…è¨±ç”¨æˆ¶é€é Telegram æŸ¥çœ‹ Lambda æ”¶åˆ°çš„å®Œæ•´ API Gateway eventï¼Œæ–¹ä¾¿é–‹ç™¼å’Œæ•…éšœæ’é™¤ã€‚

## æ–°å¢æª”æ¡ˆ

### 1. `src/telegram_client.py`
- **ç”¨é€”**: Telegram Bot API å®¢æˆ¶ç«¯
- **ä¸»è¦åŠŸèƒ½**:
  - `send_message()` - ç™¼é€è¨Šæ¯åˆ° Telegram
  - `send_long_message()` - è‡ªå‹•åˆ†æ®µç™¼é€é•·è¨Šæ¯
  - `send_debug_info()` - æ ¼å¼åŒ–ä¸¦ç™¼é€é™¤éŒ¯è³‡è¨Š
  - `_split_message()` - è¨Šæ¯åˆ†å‰²é‚è¼¯
- **ä¾è³´**: ä½¿ç”¨ Python å…§å»ºçš„ `urllib`ï¼Œç„¡éœ€é¡å¤–å¥—ä»¶

### 2. `tests/test_telegram_client.py`
- **ç”¨é€”**: Telegram Client çš„å–®å…ƒæ¸¬è©¦
- **æ¸¬è©¦æ¡ˆä¾‹**: 13 å€‹æ¸¬è©¦ï¼Œæ¶µè“‹ï¼š
  - æˆåŠŸç™¼é€è¨Šæ¯
  - éŒ¯èª¤è™•ç†ï¼ˆç„¡ tokenã€API éŒ¯èª¤ã€ç¶²è·¯éŒ¯èª¤ï¼‰
  - è¨Šæ¯åˆ†å‰²
  - é™¤éŒ¯è³‡è¨Šç™¼é€

### 3. `tests/conftest.py`
- **ç”¨é€”**: Pytest é…ç½®æª”æ¡ˆ
- **åŠŸèƒ½**: è¨­å®š Python æ¨¡çµ„è·¯å¾‘ï¼Œä¿®æ­£æ¸¬è©¦å°å…¥å•é¡Œ

### 4. `DEBUG_COMMAND.md`
- **ç”¨é€”**: é™¤éŒ¯åŠŸèƒ½è©³ç´°èªªæ˜æ–‡ä»¶
- **å…§å®¹**: ä½¿ç”¨æ–¹å¼ã€å®‰å…¨æ³¨æ„äº‹é …ã€æŠ€è¡“å¯¦ä½œã€æ•…éšœæ’é™¤

### 5. `CHANGELOG_DEBUG_FEATURE.md`
- **ç”¨é€”**: æœ¬è®Šæ›´æ—¥èªŒ

## ä¿®æ”¹æª”æ¡ˆ

### 1. `src/handler.py`
**è®Šæ›´å…§å®¹**:
- æ–°å¢ `from telegram_client import send_debug_info`
- æ–°å¢ `/debug test` æŒ‡ä»¤æª¢æ¸¬é‚è¼¯
- åœ¨é©—è­‰ chat_id å¾Œã€å…è¨±åå–®æª¢æŸ¥å‰è™•ç†é™¤éŒ¯æŒ‡ä»¤
- è¿”å› `debug_sent` æˆ– `debug_failed` ç‹€æ…‹

**ç¨‹å¼ç¢¼ç‰‡æ®µ**:
```python
# æª¢æŸ¥æ˜¯å¦ç‚º /debug test æŒ‡ä»¤
if text and text.strip() == '/debug test':
    # ç™¼é€é™¤éŒ¯è³‡è¨Š
    debug_sent = send_debug_info(chat_id, event)
    if debug_sent:
        return create_response(200, {'status': 'debug_sent'})
    else:
        return create_response(200, {'status': 'debug_failed'})
```

### 2. `template.yaml`
**è®Šæ›´å…§å®¹**:
- æ–°å¢ç’°å¢ƒè®Šæ•¸ `TELEGRAM_BOT_TOKEN: ''`

**ç¨‹å¼ç¢¼ç‰‡æ®µ**:
```yaml
Environment:
  Variables:
    TELEGRAM_SECRET_TOKEN: ''
    TELEGRAM_BOT_TOKEN: ''        # æ–°å¢
    SQS_QUEUE_URL: !Ref TelegramInboundQueue
    ALLOWLIST_TABLE_NAME: !Ref AllowlistTable
```

### 3. `tests/test_handler.py`
**è®Šæ›´å…§å®¹**:
- æ–°å¢ 6 å€‹æ¸¬è©¦æ¡ˆä¾‹ï¼š
  - `test_debug_command` - åŸºæœ¬é™¤éŒ¯æŒ‡ä»¤æ¸¬è©¦
  - `test_debug_command_with_spaces` - å¸¶ç©ºæ ¼çš„æŒ‡ä»¤
  - `test_debug_command_send_failure` - ç™¼é€å¤±æ•—æƒ…æ³
  - `test_non_debug_command` - ç¢ºä¿éé™¤éŒ¯æŒ‡ä»¤æ­£å¸¸è™•ç†
  - `test_debug_command_missing_chat_id` - ç¼ºå°‘ chat_id çš„éŒ¯èª¤è™•ç†

### 4. `README.md`
**è®Šæ›´å…§å®¹**:
- æ–°å¢ã€ŒğŸ› é™¤éŒ¯åŠŸèƒ½ã€ç« ç¯€
- æ›´æ–°ç’°å¢ƒè®Šæ•¸è¡¨æ ¼ï¼Œæ–°å¢ `TELEGRAM_BOT_TOKEN`
- æ›´æ–°å°ˆæ¡ˆçµæ§‹ï¼Œæ–°å¢ `telegram_client.py` å’Œ `test_telegram_client.py`

## æ¸¬è©¦çµæœ

```
âœ… 46 å€‹æ¸¬è©¦å…¨éƒ¨é€šé
- test_allowlist.py: 10 å€‹æ¸¬è©¦é€šé
- test_handler.py: 16 å€‹æ¸¬è©¦é€šéï¼ˆå« 6 å€‹æ–°æ¸¬è©¦ï¼‰
- test_sqs_client.py: 7 å€‹æ¸¬è©¦é€šé
- test_telegram_client.py: 13 å€‹æ¸¬è©¦é€šéï¼ˆæ–°å¢ï¼‰
```

## ä½¿ç”¨æ–¹å¼

1. **è¨­å®š Bot Token**:
   ```bash
   aws lambda update-function-configuration \
     --function-name telegram-lambda-receiver \
     --environment Variables="{...TELEGRAM_BOT_TOKEN='YOUR_TOKEN'...}"
   ```

2. **ç™¼é€æŒ‡ä»¤**:
   åœ¨ Telegram ä¸­å‘ Bot ç™¼é€ `/debug test`

3. **æŸ¥çœ‹çµæœ**:
   Bot æœƒå›è¦†å®Œæ•´çš„ API Gateway event JSON

## å®‰å…¨è€ƒé‡

âš ï¸ **é‡è¦**: ç•¶å‰å¯¦ä½œç‚º**å®Œå…¨æ”¾è¡Œ**ï¼Œä»»ä½•ç”¨æˆ¶éƒ½å¯ä½¿ç”¨æ­¤æŒ‡ä»¤ã€‚

**å»ºè­°**:
- åƒ…åœ¨é–‹ç™¼/æ¸¬è©¦ç’°å¢ƒä½¿ç”¨
- ç”Ÿç”¢ç’°å¢ƒæ‡‰ç§»é™¤æˆ–åŠ ä¸Šå…è¨±åå–®é™åˆ¶
- å®šæœŸæª¢è¦–é™¤éŒ¯æ—¥èªŒ

## æŠ€è¡“ç´°ç¯€

### æ¶æ§‹æ±ºç­–
1. **åŒæ­¥è™•ç†**: åœ¨ Lambda ä¸­åŒæ­¥ç™¼é€é™¤éŒ¯è¨Šæ¯ï¼Œä¸ç¶“é SQS
2. **ç„¡é¡å¤–ä¾è³´**: ä½¿ç”¨ Python å…§å»º `urllib`ï¼Œä¿æŒå°ˆæ¡ˆè¼•é‡
3. **è‡ªå‹•åˆ†æ®µ**: è™•ç†è¶…é 4096 å­—å…ƒçš„é•·è¨Šæ¯
4. **å„ªå…ˆé©—è­‰**: å…ˆé©—è­‰ chat_id å­˜åœ¨ï¼Œå†è™•ç†é™¤éŒ¯æŒ‡ä»¤

### æ•ˆèƒ½å½±éŸ¿
- å¢åŠ ä¸€å€‹å¤–éƒ¨ HTTP è«‹æ±‚ï¼ˆTelegram APIï¼‰
- é ä¼°å¢åŠ  200-500ms è™•ç†æ™‚é–“
- åƒ…å½±éŸ¿ `/debug test` æŒ‡ä»¤ï¼Œä¸å½±éŸ¿æ­£å¸¸è¨Šæ¯

## å¾ŒçºŒæ”¹é€²å»ºè­°

1. **çŸ­æœŸ**:
   - [ ] åŠ å…¥å…è¨±åå–®é™åˆ¶
   - [ ] éæ¿¾æ•æ„Ÿç’°å¢ƒè®Šæ•¸

2. **ä¸­æœŸ**:
   - [ ] æ”¯æ´æ›´å¤šé™¤éŒ¯æŒ‡ä»¤ï¼ˆå¦‚ `/debug env`ã€`/debug stats`ï¼‰
   - [ ] åŠ å…¥æŒ‡ä»¤æ¬Šé™ç®¡ç†

3. **é•·æœŸ**:
   - [ ] å»ºç«‹å®Œæ•´çš„æŒ‡ä»¤ç³»çµ±æ¡†æ¶
   - [ ] æ”¯æ´äº’å‹•å¼é™¤éŒ¯

## å…¼å®¹æ€§

- âœ… å‘å¾Œå…¼å®¹ï¼šä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½
- âœ… å¯é¸åŠŸèƒ½ï¼šæœªè¨­å®š Bot Token æ™‚ä¸å½±éŸ¿æ­£å¸¸é‹ä½œ
- âœ… æ¸¬è©¦è¦†è“‹ï¼šæ‰€æœ‰æ–°åŠŸèƒ½éƒ½æœ‰å®Œæ•´æ¸¬è©¦

## æª”æ¡ˆçµ±è¨ˆ

- **æ–°å¢æª”æ¡ˆ**: 5 å€‹
- **ä¿®æ”¹æª”æ¡ˆ**: 4 å€‹
- **æ–°å¢ç¨‹å¼ç¢¼**: ~400 è¡Œ
- **æ–°å¢æ¸¬è©¦**: 19 å€‹æ¸¬è©¦æ¡ˆä¾‹
- **æ¸¬è©¦é€šéç‡**: 100% (46/46)
